# vertebra-classification


## Быстрый старт

- Установите зависимости используя следующую команду:
```bash
sudo -H pip3 install -r requirements.txt
```

- Используйте скрипт `demo_app.py` на своих данных:
```bash
python3 demo/demo_app.py --images PATH_TO_FOLDER_WITH_IMAGES_ONLY
```

## Постановка задачи

Детекция по принципу **здоров/не здоров** для **каждого** 
межпозвоночного диска **шейного** отдела.


## Анализ данных


#### Анализ 

Датасет содержит квадратные RGB изображения (можно конвертировать в ЧБ так как 
чистый скан является ЧБ изображением). 
Размер каждого изображения: 384х384 или 512х512.

- Размер входного датасета: 891 изображение и 12 файлов разметки которые 
хранят аннотацию для каждого изображения.
- Количество уникальных классов в разметке: 8
- Количество пригодных для разметки семплов: 365
- Количество семплов содержащих хотя бы один межпозвоночный диск шейного отдела: 343
- Медианное количество размеченных межпозвоночных дисков шейного отдела: 5

Так как исходная разметка содержит 8 классов конвертируем их в 2 
(здоров/не здоров).

Распределение изображений по количеству размеченных межпозвоночных дисков шейного отдела:

![raw_hist.png](content/raw_hist.png?raw=true)

Основываясь на этой гистограмме было принято решение отсечь семплы которые 
содержат меньше 4 и больше 6 размеченных дисков. Итоговая гистограмма:

![processed_hist.png](content/processed_hist.png?raw=true) 

- Итоговое количество используемых семплов: 328
- Количество размеченных дисков на итоговом датасете: 1641
- Количество здоровых дисков (1 класс): 920 (56%)
- Количество паталогических дисков (2 класс): 721 (44%)


##### Проблемы датасета:

- Некоторые изображения значительно ярче большинства
- Некоторые изображения имеют странную разметку

Пример странной разметки:

![img_00122.jpg](content/img_00122.jpg?raw=true)
![img_00123.jpg](content/img_00123.jpg?raw=true)

Пояснение: два соседних изображения одного пациента, но в одном случае 
второй диск сверху размечен как здоровы, во втором - как больной. Также 
последний диск снизу либо размечен лишним в одном случае, либо не 
размечен в другом.


#### Пример входных данных

##### 512x512

![img_00005.jpg](content/img_00492.jpg?raw=true)
![img_00005.jpg](content/img_00981.jpg?raw=true)


##### 384x384

![img_00642.jpg](content/img_00642_raw.jpg?raw=true)
![img_00644.jpg](content/img_00644.jpg?raw=true)


#### Пример данных с обработанной разметкой

![img_00005.jpg](content/img_00005.jpg?raw=true)
![img_00005.jpg](content/img_00347.jpg?raw=true)
![img_00005.jpg](content/img_00381.jpg?raw=true)
![img_00005.jpg](content/img_00642.jpg?raw=true)


## Архитектура сети

Выбор происходил между YOLOv3 и FasterRCNN. Изначально была выбрана YOLOv3, 
однако после проблем с её обучением (была использована сторонняя 
имплементация) а так же из-за того что FasterRCNN является более точной 
архитектурой, хоть и более медленной и тяжеловесной, в качестве 
архитектуры была выбрана **FasterRCNN**.

## Подготовка данных

Для обработки данных и подготовки выборок для обучения и теста был разработан 
скрипт `tools/prepare_markup.py`. С помощью него можно:
- подготовить train/test выборки 
- посчитать `mean` и `std` для нормализации картинок во время обучения 
(считается по всем переданным картинкам)
- найти удалить дубликаты разметки межпозвоночных дисков (дубликат 
определяется с помощью IoU)
 - удалить из итоговой выборки семплы на которых количество размеченных 
 дисков меньше чем N (параметр)
- визуализировать и сохранить изображения с отрисованной разметкой

Для обучения были сгенерированны выборки train/test с параметрами в файле 
`tools/prepare_markup.cfg`.
Скрипт поддерживает запуск с конфиг файлом (параметр `--config`).


## Проесс обучения

Процесс обучения был разработан на основе фреймворка PyTorch. Скрипт для 
обучения на

3. Train analysis
4. Model
5. Results of training
6. Conclusion
